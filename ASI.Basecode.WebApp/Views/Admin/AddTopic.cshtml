@model TopicViewModel
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

<div id="addTopic" class="fixed inset-0 z-50 flex hidden items-center justify-center bg-black bg-opacity-40 backdrop-blur-sm">
    <div class="flex max-h-[90vh] w-full max-w-5xl flex-col rounded-xl bg-white p-6 text-black shadow-lg">

        <div class="flex">
            <a onclick="closeAddTopic()" class="hover-pointer">
                <span class="material-symbols-outlined text-[50px]">arrow_circle_left</span>
            </a>
        </div>
        <div class="align-items-center mx-5 my-3 flex w-full justify-start">
            <h1 class="font-weight-bold text-2xl uppercase">Add New Topic</h1>
        </div>
        <form asp-controller="AdminTopic" asp-action="AddTopic" method="post" enctype="multipart/form-data" id="addTopicForm">
            <div class="flex">
                <!-- Left side with form fields -->
                <input type="hidden" asp-for="TrainingId" id="TrainingId" />
                <div class="flex w-1/2 flex-col">
                    <div class="mx-5 mt-2">
                        <label asp-for="TopicName" class="mb-2 block text-sm font-medium text-black">Topic Name</label>
                        <input asp-for="TopicName" class="w-full rounded-md border border-gray-300 px-3 py-2 text-black focus:outline-none focus:ring-2 focus:ring-[#EAC231]" />
                        <span asp-validation-for="TopicName" class="text-danger"></span>
                    </div>

                    <div class="mx-5 mt-2">
                        <label asp-for="Description" class="mb-2 block text-sm font-medium text-black">Description</label>
                        <textarea asp-for="Description" rows="12" class="w-full rounded-md border border-gray-300 px-3 py-2 text-black focus:outline-none focus:ring-2 focus:ring-[#EAC231]"></textarea>
                        <span asp-validation-for="Description" class="text-danger"></span>
                    </div>

                    <button type="submit" class="mx-5 mt-4 rounded-lg bg-[#FFE9C6] px-4 py-2 font-semibold">Add Topic</button>
                </div>

                <div class="flex w-1/2 flex-col gap-2 rounded-lg bg-[#640A16] p-4 text-white">
                    <h2 class="text-2xl font-semibold">Resources</h2>
                    <p class="text-sm text-gray-300">Maximum 100MB per category (Videos, Images, Documents)</p>

                    <div class="flex flex-1 flex-col gap-2">
                        <!-- Videos -->
                        <div class="flex flex-1 flex-col">
                            <div class="flex justify-between">
                                <p class="text-lg">Videos</p>
                                <div id="VideoSizeDisplayAdd" class="mt-1 text-xs">Total video size: 0.00MB / 100MB</div>
                                <label for="VideoFilesAdd" class="cursor-pointer">
                                    <input type="file"
                                           name="VideoFilesAdd"
                                           id="VideoFilesAdd"
                                           accept="video/*"
                                           multiple
                                           class="hidden" />
                                    <div class="flex items-center text-white">
                                        <span class="material-symbols-outlined">add_photo_alternate</span>
                                        <h1 class="font-semibold uppercase">Upload</h1>
                                    </div>
                                </label>
                            </div>
                            <div class="flex w-full flex-1 flex-col items-center rounded-xl bg-white p-2">
                                <div id="VideoPreviewAdd" class="flex h-full w-full items-center gap-2 overflow-x-auto text-black">
                                </div>
                            </div>
                        </div>

                        <!-- Images -->
                        <div class="flex flex-1 flex-col">
                            <div class="flex justify-between">
                                <p class="text-lg">Images</p>
                                <div id="ImageSizeDisplayAdd" class="mt-1 text-xs">Total image size: 0.00MB / 100MB</div>
                                <label for="ImageFilesAdd" class="cursor-pointer">
                                    <input type="file"
                                           name="ImageFilesAdd"
                                           id="ImageFilesAdd"
                                           accept="image/*"
                                           multiple
                                           class="hidden" />
                                    <div class="flex items-center text-white">
                                        <span class="material-symbols-outlined">add_photo_alternate</span>
                                        <h1 class="font-semibold uppercase">Upload</h1>
                                    </div>
                                </label>
                            </div>
                            <div class="flex w-full flex-1 flex-col items-center rounded-xl bg-white p-2">
                                <div id="ImagePreviewAdd" class="flex h-full w-full items-center gap-2 overflow-x-auto text-black">
                                </div>
                            </div>
                        </div>

                        <!-- Documents -->
                        <div class="flex flex-1 flex-col">
                            <div class="flex justify-between">
                                <div class="flex flex-col">
                                    <p class="text-lg">Documents</p>
                                    <p class="text-xs text-gray-300">PDF, Word, Excel, PowerPoint</p>
                                    <div id="DocumentSizeDisplayAdd" class="mt-1 text-xs">Total document size: 0.00MB / 100MB</div>
                                </div>
                                <label for="DocumentFilesAdd" class="cursor-pointer">
                                    <input type="file"
                                           name="DocumentFilesAdd"
                                           id="DocumentFilesAdd"
                                           accept="application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-powerpoint,application/vnd.openxmlformats-officedocument.presentationml.presentation"
                                           multiple
                                           class="hidden" />
                                    <div class="flex items-center text-white">
                                        <span class="material-symbols-outlined">add_photo_alternate</span>
                                        <h1 class="font-semibold uppercase">Upload</h1>
                                    </div>
                                </label>
                            </div>
                            <div class="flex w-full flex-1 flex-col items-center rounded-xl bg-white p-2">
                                <div id="DocumentPreviewAdd" class="flex h-full w-full items-center gap-2 overflow-x-auto text-black">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    function addTopic(trainingId) {
        document.getElementById('addTopic').classList.remove('hidden');
        document.getElementById('TrainingId').value = trainingId;
    }

    function closeAddTopic() {
        document.getElementById('addTopic').classList.add('hidden');
        // Clear form
        document.getElementById('VideoPreviewAdd').innerHTML = '';
        document.getElementById('ImagePreviewAdd').innerHTML = '';
        document.getElementById('DocumentPreviewAdd').innerHTML = '';
        document.getElementById('VideoFilesAdd').value = '';
        document.getElementById('ImageFilesAdd').value = '';
        document.getElementById('DocumentFilesAdd').value = '';
    }

    function getFileExtension(filename) {
        return filename.split('.').pop().toUpperCase();
    }

    function getFileExtensionColor(extension) {
        switch(extension.toLowerCase()) {
            case 'pdf': return 'bg-red-500';
            case 'doc':
            case 'docx': return 'bg-blue-500';
            case 'xls':
            case 'xlsx': return 'bg-green-500';
            case 'ppt':
            case 'pptx': return 'bg-orange-500';
            default: return 'bg-gray-500';
        }
    }

    function updateSizeInfo(inputId, previewId, type) {
        const files = document.getElementById(inputId).files;
        let totalSize = 0;
        for (let i = 0; i < files.length; i++) {
            totalSize += files[i].size;
        }

        const sizeInMB = (totalSize / (1024 * 1024)).toFixed(2);
        let sizeInfo = document.getElementById(`${previewId}-size`);

        if (!sizeInfo) {
            sizeInfo = document.createElement('div');
            sizeInfo.id = `${previewId}-size`;
            sizeInfo.className = 'text-xs text-center mt-1';
            document.getElementById(previewId).appendChild(sizeInfo);
        }

        sizeInfo.textContent = `Total ${type} size: ${sizeInMB}MB / 100MB`;
        sizeInfo.style.color = totalSize > 100 * 1024 * 1024 ? 'red' : 'green';
    }

    function updateTotalResourceSizeAdd(type) {
        let previewId, displayId;
        if (type === 'video') {
            previewId = 'VideoPreviewAdd'; displayId = 'VideoSizeDisplayAdd';
        } else if (type === 'image') {
            previewId = 'ImagePreviewAdd'; displayId = 'ImageSizeDisplayAdd';
        } else if (type === 'document') {
            previewId = 'DocumentPreviewAdd'; displayId = 'DocumentSizeDisplayAdd';
        }
        let totalSize = 0;
        document.querySelectorAll(`#${previewId} .media-item[data-filesize]`).forEach(div => {
            totalSize += parseInt(div.getAttribute('data-filesize')) || 0;
        });
        const sizeInMB = (totalSize / (1024 * 1024)).toFixed(2);
        const display = document.getElementById(displayId);
        if (display) {
            display.textContent = `Total ${type} size: ${sizeInMB}MB / 100MB`;
            display.style.color = totalSize > 100 * 1024 * 1024 ? 'red' : '#39d353'; // bright green
        }
    }

    function addNewFilePreview(previewId, file, icon, inputId) {
        const preview = document.getElementById(previewId);
        const div = document.createElement('div');
        div.className = 'flex flex-col items-center min-w-[60px] cursor-pointer media-item new';
        div.setAttribute('data-filesize', file.size); // Ensure new file previews have data-filesize

        let fileInfo = '';
        if (inputId === 'DocumentFilesAdd') {
            const extension = getFileExtension(file.name);
            const colorClass = getFileExtensionColor(extension);
            fileInfo = `<span class='${colorClass} mt-1 rounded px-2 py-1 text-xs font-bold text-white'>${extension}</span>`;
        }

        div.innerHTML = `
            <span class="material-symbols-outlined text-black" style="font-size:30px">${icon}</span>
            <span class='w-[60px] truncate text-center text-xs text-black'>${file.name.substring(0, 10)}</span>
            ${fileInfo}
            <button type='button' class='delete-media-btn' style='color:red;'>
                <span class="material-symbols-outlined" style='font-size: 20px'>delete</span>
            </button>`;

        div.querySelector('.delete-media-btn').onclick = function(e) {
            const parentId = div.parentElement ? div.parentElement.id : '';
            div.remove();
            e.stopPropagation();
            // If no more .media-item.new in this preview, clear the file input
            if (parentId && document.querySelectorAll(`#${parentId} .media-item.new`).length === 0) {
                if (parentId === 'VideoPreviewAdd') document.getElementById('VideoFilesAdd').value = '';
                if (parentId === 'ImagePreviewAdd') document.getElementById('ImageFilesAdd').value = '';
                if (parentId === 'DocumentPreviewAdd') document.getElementById('DocumentFilesAdd').value = '';
            }
            if (parentId === 'VideoPreviewAdd') updateTotalResourceSizeAdd('video');
            if (parentId === 'ImagePreviewAdd') updateTotalResourceSizeAdd('image');
            if (parentId === 'DocumentPreviewAdd') updateTotalResourceSizeAdd('document');
        };
        preview.appendChild(div);
    }

    document.getElementById('ImageFilesAdd').addEventListener('change', function(event) {
        const preview = document.getElementById('ImagePreviewAdd');
        preview.innerHTML = ''; // Clear existing previews
        Array.from(event.target.files).forEach(file => {
            addNewFilePreview('ImagePreviewAdd', file, 'image', 'ImageFilesAdd');
        });
        updateTotalResourceSizeAdd('image');
    });

    document.getElementById('VideoFilesAdd').addEventListener('change', function(event) {
        const preview = document.getElementById('VideoPreviewAdd');
        preview.innerHTML = ''; // Clear existing previews
        Array.from(event.target.files).forEach(file => {
            addNewFilePreview('VideoPreviewAdd', file, 'movie', 'VideoFilesAdd');
        });
        updateTotalResourceSizeAdd('video');
    });

    document.getElementById('DocumentFilesAdd').addEventListener('change', function(event) {
        const preview = document.getElementById('DocumentPreviewAdd');
        preview.innerHTML = ''; // Clear existing previews
        Array.from(event.target.files).forEach(file => {
            addNewFilePreview('DocumentPreviewAdd', file, 'description', 'DocumentFilesAdd');
        });
        updateTotalResourceSizeAdd('document');
    });

    // Form validation
    document.getElementById('addTopicForm').addEventListener('submit', function(e) {
        const MAX_SIZE = 100 * 1024 * 1024; // 100MB in bytes

        // Check video files total size
        const videoFiles = document.getElementById('VideoFilesAdd').files;
        let videoTotalSize = 0;
        for (let i = 0; i < videoFiles.length; i++) {
            videoTotalSize += videoFiles[i].size;
        }
        if (videoTotalSize > MAX_SIZE) {
            alert('Total size of videos exceeds 100MB limit');
            e.preventDefault();
            return;
        }

        // Check image files total size
        const imageFiles = document.getElementById('ImageFilesAdd').files;
        let imageTotalSize = 0;
        for (let i = 0; i < imageFiles.length; i++) {
            imageTotalSize += imageFiles[i].size;
        }
        if (imageTotalSize > MAX_SIZE) {
            alert('Total size of images exceeds 100MB limit');
            e.preventDefault();
            return;
        }

        // Check document files total size
        const documentFiles = document.getElementById('DocumentFilesAdd').files;
        let documentTotalSize = 0;
        for (let i = 0; i < documentFiles.length; i++) {
            documentTotalSize += documentFiles[i].size;
        }
        if (documentTotalSize > MAX_SIZE) {
            alert('Total size of documents exceeds 100MB limit');
            e.preventDefault();
            return;
        }
    });
</script>